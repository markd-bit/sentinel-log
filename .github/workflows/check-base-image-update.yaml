name: Build and Push Docker Image
on:
  schedule:
    - cron: "0 1 * * *"  # Schedule to run daily at 01:00 UTC
  workflow_dispatch:  # Allows manual triggering of the workflow
  push:
    branches:
      - main

env:
  image: ${{ vars.DOCKER_USERNAME }}/sentinel-log
  base-image: fluent/fluentd:v1.17-debian-1

jobs:
  check-base-image:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Check if update available
        id: check
        uses: markd-bit/check-base-image-update.yaml@main
        with:
          base-image: ${{ env.base-image }}
          image: ${{ env.image }}
          platforms: linux/amd64,linux/arm64
        env:
          DEBUG: ${{ secrets.ACTIONS_STEP_DEBUG }}

      - if: steps.check.outputs.needs-updating == 'true'
        name: Build and Push Docker Image
        uses: docker/build-push-action@v2
        with:
          push: true
          tags: ${{ env.image }}:latest
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

      - if: steps.check.outputs.needs-updating == 'true'
        name: Send Telegram Notification
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            üê≥ Base image ${{ env.base-image }} of ${{ env.image }} has been updated.
            ‚öôÔ∏è Image rebuild is triggered.
            üìö Repository: [${{ github.repository }}](https://github.com/${{ github.repository }})

